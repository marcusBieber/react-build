pipeline {
    agent any

    environment {
        EC2_USER = 'ubuntu'
        EC2_HOST = '3.121.109.48' // EC2-IP anpassen
        DEPLOY_PATH = '/var/www/nginx/react-app' // Nginx-Standardverzeichnis
        SSH_CREDENTIALS = 'jenkins-ec2-key'  
        APP_URL = 'http://3.121.109.48' 
    }
    
    tools {
        nodejs 'NodeJS'
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', 
                    url: 'https://github.com/marcusBieber/react-build.git' // add some other git repository for deployment
            }
        }

        stage('Install Dependencies and Build React App') {
            steps {
                sh '''
                    npm install
                    npm run build
                '''
            }
        }

        stage('Deploy to EC2') {
            steps {
                script {
                    sshagent(credentials: [SSH_CREDENTIALS]) {
                        sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
                            echo "Prüfe Nginx-Installation..." &&
                            if ! command -v nginx &> /dev/null; then
                                echo "Nginx wird installiert..." &&
                                sudo apt update &&
                                sudo apt install -y nginx &&
                                sudo systemctl enable nginx &&
                                sudo systemctl start nginx
                            fi &&
                            
                            echo "Erstelle Deployment-Verzeichnis..." &&
                            sudo mkdir -p ${DEPLOY_PATH} &&
                            sudo chown -R ubuntu:ubuntu ${DEPLOY_PATH} &&
                            sudo rm -rf ${DEPLOY_PATH}/*'
                        
                        echo "Kopiere neuen Build auf EC2..."
                        scp -o StrictHostKeyChecking=no -r dist/* ${EC2_USER}@${EC2_HOST}:${DEPLOY_PATH}

                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
                            echo "Konfiguriere Nginx für React-App..." &&
                            echo "
                            server {
                                listen 80;
                                server_name _;
                                root ${DEPLOY_PATH};
                                index index.html;
                                location / {
                                    try_files \$uri /index.html;
                                }
                            }" | sudo tee /etc/nginx/sites-available/react-app &&
                            sudo ln -sf /etc/nginx/sites-available/react-app /etc/nginx/sites-enabled/react-app &&
                            sudo systemctl restart nginx'
                        """
                    }
                }
            }
        }
    }
}
